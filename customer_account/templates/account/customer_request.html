<!-- customer_account/templates/account/customer_request.html -->
{% extends 'base.html' %}

{% load static %}
{% load django_bootstrap5 %}

{% block title %}
{{ block.super }}: запросы товаров
{% endblock %}

{% block content %}
<div class="container col-12 margin-mb1">

    {% if results %}
    <h4>Список для запроса по наименованию: "{{ results.0.product }}" ( всего позиций: {{results.count}} )</h4>
    <!-- Отображение текущего количества в MailSendList -->
 
    <p><i>Доступно выбрать {{ mail_list_limit }} позиций за 1 рассылку.</i> <strong>Выбрано для отправки:</strong> </p>
   
   <a class="btn bg-blue1 text-decoration-none bg-hover1 color-button-text my-2 mr-2" type="post"
        href="{% url 'redirect_send_emails' %}" >Сделать запрос поставщикам</a>
      <!-- Кнопка очистки -->
    <form method="post" action="{% url 'clear_mail_send_list' %}" style="display:inline;"
        onsubmit="return confirm('Вы уверены, что хотите очистить весь список для рассылки?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-outline-danger my-2 ms-md-5">Очистить всю выборку</button>
    </form>

   </div>
    
      

    <table class="table table-striped demotable ">
        <thead style="position: sticky;top: -1px;z-index:1;background: #9d9e9e; font-size:14px">
            <tr>
                <th scope="col">Поставщик</th>
                <th scope="col">Страна</th>
                <th scope="col" class="d-none d-md-table-cell">Email</th>
                <th scope="col" class="d-none d-md-table-cell">Дата запроса</th>
                <th scope="col">Выбрать для отправки</th>
            </tr>
        </thead>
        <tbody style="font-size:12px">
            {% for item in results %}
            <tr>
                <th>
                    <a href="{% url 'supplier_detail' item.supplier_name_id %}" target="_blank">
                        {{ item.supplier_name}}
                    </a>
                </th>
                <td>{{ item.country}}</td>
                <td class="d-none d-md-table-cell">{{item.supplier_email}}</td>
                <td class="d-none d-md-table-cell">{{item.created_at}}</td>
                <!-- Новая ячейка с чекбоксом -->
                <td class="text-center">
                    <input type="checkbox" class="select-supplier-checkbox" data-supplier-id="{{ item.id }}"
                        data-section="Товары" {% if item.is_selected %}checked{% endif %}>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}

    <h2 class=" mt-1">История подбора поставщиков товаров </h2>
    Всего запрошен поиск уникальных товаров: {{unique_request}}. Подобрано позиций поставщиков: {{count}}

    <form method="post">
        <div class="d-flex flex-md-row flex-wrap">
            <div class=" mt-1 me-2 mb-2">
                {% csrf_token %}
                <div id="id_search_product">
                    {{ form.search_product.label_tag }}
                    {{ form.search_product }}
                </div>
            </div>
            <div class=" mt-1 me-2 mb-2">
                <div id="id_search_country">
                    {{ form.search_country.label_tag }}
                    {{ form.search_country }}
                </div>
            </div>
            <div class="ms-2 mt-1">
                <button type="submit" class="btn btn-sm bg-blue1 bg-hover1 color-button-text btn-block">
                    Показать результаты
                </button>
            </div>
        </div>
    </form>

    {% endif %}

</div>
{% block scripts %}
<script>
    // --- Обработчик чекбоксов ---
    document.addEventListener('DOMContentLoaded', function () {
        const checkboxes = document.querySelectorAll('.select-supplier-checkbox');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const supplierId = this.getAttribute('data-supplier-id');
                const section = this.getAttribute('data-section');
                const action = this.checked ? 'add' : 'remove';

                fetch('{% url "save_selected_suppliers" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                    },
                    body: `supplier_id=${supplierId}&action=${action}&section=${section}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector('p strong').textContent = `Выбрано для отправки: ${data.current_count}`;
                    } else {
                        this.checked = !this.checked;
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при сохранении выбора:', error);
                    this.checked = !this.checked;
                    alert('Произошла ошибка при сохранении выбора.');
                });
            });
        });
    });

    // --- Обработчик динамического обновления стран ---
    document.addEventListener('DOMContentLoaded', function() {
        // Проверяем, был ли скрипт уже запущен
        if (window.dynamicCountryScriptLoaded) {
            console.warn('Dynamic country script already loaded, skipping.');
            return;
        }
        window.dynamicCountryScriptLoaded = true; // Устанавливаем флаг

        const productSelect = document.querySelector('#id_search_product select');
        const countrySelect = document.querySelector('#id_search_country select');

        if (!productSelect || !countrySelect) {
            console.warn('Elements for dynamic country update not found. Skipping initialization.');
            return;
        }

        const initialCountryOptions = Array.from(countrySelect.options);

        productSelect.addEventListener('change', function() {
            const selectedProduct = productSelect.value;
            countrySelect.innerHTML = '';

            if (!selectedProduct) {
                initialCountryOptions.forEach(option => {
                    countrySelect.appendChild(option.cloneNode(true));
                });
                return;
            }

            console.log('Fetching countries for product ID:', selectedProduct);

            fetch('{% url "get_countries_for_product" %}?product=' + encodeURIComponent(selectedProduct), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Received countries:', data.countries);

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.text = 'выбрать страну';
                countrySelect.appendChild(defaultOption);

                if (data.countries && data.countries.length > 0) {
                    data.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.text = country;
                        countrySelect.appendChild(option);
                    });
                } else {
                    const noOption = document.createElement('option');
                    noOption.value = '';
                    noOption.text = 'Нет доступных стран';
                    noOption.disabled = true;
                    countrySelect.appendChild(noOption);
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке стран:', error);
                alert('Ошибка при загрузке стран.');
                initialCountryOptions.forEach(option => {
                    countrySelect.appendChild(option.cloneNode(true));
                });
            });
        });
    });
</script>
{% endblock scripts %}

{% endblock %}